{% extends 'base.html' %}
{% load static %}

{% block title %}
  Editar Transporte
{% endblock %}

{% block content %}

<div class="container py-4">

  <div class="card shadow border-0 rounded-4 mx-auto" style="max-width: 1150px;">
    <div class="card-body p-4">

      <!-- ================= HEADER ================= -->
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
        <div>
          <h4 class="fw-bold text-primary mb-1">
            <i class="bi bi-truck-front-fill me-1"></i> Editar Transporte
          </h4>
          <small class="text-muted">
            Gestão de LECOM, veículo, cargas e entregas
          </small>
        </div>
      </div>
      
      <form method="post">
        {% csrf_token %}

        <!-- ================= DADOS DO TRANSPORTE ================= -->
        <div class="border rounded-3 p-3 mb-4 bg-light">
          <h6 class="fw-bold text-primary mb-3">
            <i class="bi bi-info-circle me-1"></i> Dados do Transporte
          </h6>

          <!-- STATUS INTERATIVO -->
          <div class="d-flex align-items-center gap-3 mb-3">
            <span class="fw-semibold small">Status:</span>

            <div id="statusToggle" class="status-toggle {% if lecom.status == 'LIBERADO' %}status-ok{% else %}status-block{% endif %}">
              <i id="statusIcon" class="bi {% if lecom.status == 'LIBERADO' %}bi-unlock{% else %}bi-lock{% endif %} me-1"></i>
              <span id="statusText">{{ lecom.status }}</span>
            </div>

            <input type="hidden" name="status" id="statusInput" value="{{ lecom.status }}">
          </div>

          <div class="row g-3">
            <div class="col-md-2">
              <label class="form-label small">LECOM</label>
              <input type="text" name="lecom"
                     class="form-control form-control-sm"
                     value="{{ lecom.lecom|default:'' }}" required>
            </div>

            <div class="col-md-3">
              <label class="form-label small">Destino</label>
              <input type="text" name="destino"
                     class="form-control form-control-sm"
                     value="{{ lecom.destino|default:'' }}" required>
            </div>

            <div class="col-md-1">
              <label class="form-label small">UF</label>
              <input type="text" name="uf"
                     maxlength="2"
                     class="form-control form-control-sm text-uppercase"
                     value="{{ lecom.uf|default:'' }}" required>
            </div>

            <div class="col-md-2">
              <label class="form-label small">Data</label>
              <input type="date" name="data"
                     class="form-control form-control-sm"
                     value="{{ lecom.data|date:'Y-m-d' }}" required>
            </div>

            <div class="col-md-2">
              <label class="form-label small">Veículo</label>
              <input type="text" name="tipo_veiculo"
                     class="form-control form-control-sm"
                     value="{{ lecom.veiculo.tipo_veiculo|default:'' }}"
                     placeholder="Truck, Carreta">
            </div>

            <div class="col-md-1">
              <label class="form-label small">Peso</label>
              <input type="number" step="0.01" name="peso"
                    class="form-control form-control-sm"
                    placeholder="0.00"
                    value="{{ lecom.peso|stringformat:'0.2f' }}">
            </div>

            <div class="col-md-1">
              <label class="form-label small">m³</label>
              <input type="number" step="0.01" name="m3"
                    class="form-control form-control-sm"
                    placeholder="0.00"
                    value="{{ lecom.m3|stringformat:'0.2f' }}">
            </div>

            <div class="col-md-12">
              <label class="form-label small">Observação</label>
              <input type="text" name="observacao"
                     class="form-control form-control-sm"
                     value="{{ lecom.observacao|default:'' }}">
            </div>
          </div>
        </div>

        <!-- ================= CARGAS ================= -->
        <div class="border rounded-3 p-3 mb-4">
          <h6 class="fw-bold text-primary mb-3">
            <i class="bi bi-box-seam me-1"></i> Cargas
          </h6>

          <div class="row g-3 mb-3">
            <div class="col-md-2">
              <label class="form-label small">Qtd. de Cargas</label>
              <input type="number" id="seqInput"
                  class="form-control form-control-sm"
                  min="1"
                  value="{% if lecom %}{{ lecom.cargas.count }}{% else %}1{% endif %}"
                  required>
            
            </div>
          </div>

          <div class="row g-3" id="cargasContainer"></div>
        </div>

        <!-- ================= AÇÕES ================= -->
        <div class="d-flex justify-content-between align-items-center border-top pt-3">
          <a href="{% url 'transport:cenario_transporte' %}"
             class="btn btn-outline-secondary btn-sm px-4">
            <i class="bi bi-arrow-left me-1"></i> Voltar
          </a>

          <button type="submit" class="btn btn-primary" id="btnSalvar">
              <span id="btnText">Salvar</span>
              <span id="btnLoader" class="spinner-border spinner-border-sm ms-2 d-none"
                    role="status" aria-hidden="true"></span>
          </button>

        </div>

      </form>
    </div>
  </div>
</div>
<link rel="stylesheet" href="{% static 'css/transporte/inserir_carga.css' %}">
<script src="{% static 'js/editar_transporte.js' %}"></script>
<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const seqInput = document.getElementById("seqInput");
  const cargasContainer = document.getElementById("cargasContainer");

  const cargasExistentes = [
    {% for carga in lecom.cargas.all %}
      {
        carga: "{{ carga.carga }}",
        seq: "{{ carga.seq }}",
        total_entregas: "{{ carga.total_entregas }}",
        mod: "{{ carga.mod }}"
      },
    {% endfor %}
  ];

  function renderCargas() {
    const qtd = parseInt(seqInput.value) || 0;
    cargasContainer.innerHTML = "";

    for (let i = 0; i < qtd; i++) {
      const data = cargasExistentes[i] || {};
      cargasContainer.innerHTML += `
        <div class="col-md-4">
          <div class="border rounded-3 p-3 h-100 bg-light">
            <strong class="text-primary small d-block mb-2">Carga ${i + 1}</strong>
            <input type="text" name="carga[]" class="form-control form-control-sm mb-2" placeholder="Carga" value="${data.carga || ''}" required>
            <input type="number" name="seq[]" class="form-control form-control-sm mb-2" placeholder="Seq" value="${data.seq || (i+1)}">
            <input type="number" name="total_entregas[]" class="form-control form-control-sm mb-2" placeholder="Entregas" value="${data.total_entregas || 1}">
            <input type="text" name="mod[]" class="form-control form-control-sm" placeholder="MOD" value="${data.mod || '-'}">
          </div>
        </div>
      `;
    }
  }

  seqInput.addEventListener("input", renderCargas);
  renderCargas();

  // Toggle de status
  const statusToggle = document.getElementById("statusToggle");
  const statusInput = document.getElementById("statusInput");
  const statusText = document.getElementById("statusText");
  const statusIcon = document.getElementById("statusIcon");

  statusToggle.addEventListener("click", () => {
    if (statusInput.value === "LIBERADO") {
      statusInput.value = "BLOQUEADO";
      statusText.textContent = "BLOQUEADO";
      statusToggle.classList.remove("status-ok");
      statusToggle.classList.add("status-block");
      statusIcon.classList.remove("bi-unlock");
      statusIcon.classList.add("bi-lock");
    } else {
      statusInput.value = "LIBERADO";
      statusText.textContent = "LIBERADO";
      statusToggle.classList.remove("status-block");
      statusToggle.classList.add("status-ok");
      statusIcon.classList.remove("bi-lock");
      statusIcon.classList.add("bi-unlock");
    }
  });
});
</script>
{% endblock %}
