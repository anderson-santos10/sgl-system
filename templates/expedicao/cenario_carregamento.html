{% extends 'base.html' %}
{% load static %}

{% block title %}Cenário de Carregamento{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/sgl-base.css' %}">

<style>
.grupo-lecom {
  border: 2px solid #dee2e6;
  border-radius: 1rem;
  padding: .75rem;
  background: #f1f3f5;
}
</style>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="page-header">
            <h4 class="fw-bold text-primary mb-1">
                <i class="bi bi-card-checklist me-1"></i> Cenário Carregamento
            </h4>
            <small class="text-muted">Visualização das cargas do transporte</small>
        </div>
    </div>

    {% regroup cargas by controle.lecom as grupos %}

    {% for grupo in grupos %}
    <div class="mb-4">

        <!-- AGRUPADOR DO TRANSPORTE -->
        <div class="grupo-lecom">

            <!-- CABEÇALHO DO TRANSPORTE -->
            <div class="card mb-2 p-3 shadow-sm">
                <h5 class="fw-bold mb-1">
                    <i class="bi bi-truck me-1"></i>
                    Transporte: {{ grupo.grouper.lecom }}
                </h5>
                <small class="text-muted">
                    Destino: {{ grupo.grouper.destino }} / {{ grupo.grouper.uf }}
                </small>
            </div>

            <!-- CARGAS DO TRANSPORTE -->
            <div class="row g-4">

                {% for carga in grupo.list %}
                <div class="col-md-6 col-lg-3" id="carga-{{ carga.id }}">
                    <div class="sgl-card shadow-sm border-0 h-100 d-flex flex-column position-relative">

                        <!-- Badge Status -->
                        <div class="sgl-badge position-absolute top-2 end-2">
                            {% include "components/status_badge.html" with status=carga.status %}
                        </div>

                        <div class="card-body d-flex flex-column mt-4">

                            <!-- Info básica -->
                            <h6 class="fw-bold mb-2">
                                <i class="bi bi-hash me-1"></i>
                                N°: <span class="fw-bold">{{ carga.numero_transporte|default:"—" }}</span>
                            </h6>

                            <ul class="list-unstyled mb-2 small">
                                <li><i class="bi bi-calendar-date me-1"></i> Início Carregamento: {{ carga.inicio_separacao|default:"—" }}</li>
                                <li><i class="bi bi-people me-1"></i> Carregadores: {{ carga.separadores|default:"—" }}</li>
                                <li><i class="bi bi-person-check me-1"></i> Conferente: {{ carga.conferente|default:"—" }}</li>
                            </ul>

                            <!-- Ações -->
                            <div class="mt-2">
                                {% if carga.status == 'Pendente' %}
                                <form method="post" action="#carga-{{ carga.id }}">
                                    {% csrf_token %}
                                    <input type="hidden" name="carga_id" value="{{ carga.id }}">
                                    <button type="submit" class="sgl-btn sgl-btn-outline-secondary w-100">
                                        <i class="bi bi-play-circle me-1"></i> Iniciar
                                    </button>
                                </form>

                                {% elif carga.status == 'Em Andamento' %}
                                <form method="post" action="#carga-{{ carga.id }}">
                                    {% csrf_token %}
                                    <input type="hidden" name="carga_id" value="{{ carga.id }}">
                                    <button type="submit" class="sgl-btn sgl-btn-outline-warning w-100">
                                        <i class="bi bi-check2-circle me-1"></i> Finalizar
                                    </button>
                                </form>

                                {% else %}
                                <button type="button" class="sgl-btn sgl-btn-outline-success w-100" disabled>
                                    <i class="bi bi-check-circle-fill me-1"></i> Concluído
                                </button>
                                {% endif %}
                            </div>

                        </div>
                    </div>
                </div>
                {% endfor %}

            </div>

        </div>
        <!-- FIM AGRUPADOR -->

    </div>
    {% empty %}
    <p class="text-center text-muted mt-4">Nenhuma carga encontrada.</p>
    {% endfor %}

</div>
{% endblock %}
