{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Editar Transporte{% endblock %}

{% block content %}
<div class="container mt-5 d-flex justify-content-center">
  <div class="card shadow-lg border-0 rounded-4" style="max-width: 800px;">
    <div class="card-body p-5">
      
      <!-- Título -->
      <h2 class="text-center fw-bold mb-4 text-primary">
        <i class="bi bi-truck-front-fill me-2"></i>
        Editar Transporte
      </h2>

      <!-- Mensagens -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mt-3">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form method="post" novalidate>
        {% csrf_token %}
        <div class="row g-4">

          {% if form.lecom %}
          <div class="col-12 col-md-4">
            <label class="form-label">
              <i class="bi bi-upc-scan text-secondary me-1"></i> LECOM
            </label>
            {{ form.lecom|add_class:"form-control text-muted"|attr:"required" }}
          </div>
          {% endif %}

          <!-- SEQ -->
          <div class="col-12 col-md-2">
            <label class="form-label">
              <i class="bi bi-list-ol text-secondary me-1"></i> SEQ
            </label>
            <input type="number" id="seqInput" name="seq" min="1" class="form-control text-muted" placeholder="Qtd" required>
          </div>

          <!-- Turno (T) -->
          <div class="col-12 col-md-2">
            <label class="form-label">
              <i class="bi bi-clock-fill text-secondary me-1"></i> T
            </label>
            {% if form.turno %}
              {{ form.turno|add_class:"form-control text-muted"|attr:"required" }}
            {% else %}
              <input type="text" name="turno" class="form-control text-muted" placeholder="Ex: Manhã" />
            {% endif %}
          </div>

          <!-- Entregas (Entr) -->
          <div class="col-12 col-md-2">
            <label class="form-label">
              <i class="bi bi-truck text-secondary me-1"></i> Entr
            </label>
            {% if form.entregas %}
              {{ form.entregas|add_class:"form-control text-muted"|attr:"placeholder:Ex: 5"|attr:"required" }}
            {% else %}
              <input type="number" name="entregas" min="0" class="form-control text-muted" placeholder="Qtd" />
            {% endif %}
          </div>

          {% if form.resumo %}
          <div class="col-12 col-md-6">
            <label class="form-label">
              <i class="bi bi-file-earmark-text text-secondary me-1"></i> Resumo
            </label>
            {{ form.resumo|add_class:"form-control text-muted"|attr:"required" }}
          </div>
          {% endif %}

          {% if form.tipo_veiculo %}
          <div class="col-12 col-md-4">
            <label class="form-label">
              <i class="bi bi-truck text-secondary me-1"></i> Tipo de Veículo
            </label>
            {{ form.tipo_veiculo|add_class:"form-control text-muted"|attr:"required" }}
          </div>
          {% endif %}

          {% if form.destino %}
          <div class="col-12 col-md-4">
            <label class="form-label">
              <i class="bi bi-geo-alt-fill text-secondary me-1"></i> Destino
            </label>
            {{ form.destino|add_class:"form-control text-muted"|attr:"placeholder:Ex: São Paulo"|attr:"required" }}
          </div>
          {% endif %}

          {% if form.uf %}
          <div class="col-12 col-md-2">
            <label class="form-label">
              <i class="bi bi-signpost-2-fill text-secondary me-1"></i> UF
            </label>
            {{ form.uf|add_class:"form-control text-muted"|attr:"required" }}
          </div>
          {% endif %}

          <!-- Data -->
          <div class="col-12 col-md-3">
            <label class="form-label">
              <i class="bi bi-calendar-date text-secondary me-1"></i> Data
            </label>
            {% if form.data %}
              {{ form.data|attr:"type:date"|add_class:"form-control text-muted"|attr:"required" }}
            {% else %}
              <input type="date" name="data" class="form-control text-muted" />
            {% endif %}
          </div>

          {% if form.peso %}
          <div class="col-12 col-md-3">
            <label class="form-label">
              <i class="bi bi-speedometer2 text-secondary me-1"></i> Peso
            </label>
            {{ form.peso|add_class:"form-control text-muted"|attr:"placeholder:Ex: 1.250 kg"|attr:"required" }}
          </div>
          {% endif %}

          {% if form.m3 %}
          <div class="col-12 col-md-3">
            <label class="form-label">
              <i class="bi bi-box text-secondary me-1"></i> M³
            </label>
            {{ form.m3|add_class:"form-control text-muted"|attr:"placeholder:Ex: 2.4"|attr:"required" }}
          </div>
          {% endif %}

          {% if form.observacao %}
          <div class="col-12">
            <label class="form-label">
              <i class="bi bi-chat-left-text text-secondary me-1"></i> Observação
            </label>
            {{ form.observacao|add_class:"form-control text-muted"|attr:"placeholder:Ex: Observações gerais..." }}
          </div>
          {% endif %}
        </div>

        <!-- Campos gerados dinamicamente -->
        <div class="row g-4 mt-4" id="cargasContainer"></div>

        <!-- Botões -->
        <div class="d-flex justify-content-end mt-4 gap-2">
          <a href="{% url 'expedicao:cenario_transporte' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle me-1"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save-fill me-1"></i> Salvar Alterações
          </button>
        </div>

        <!-- Erros -->
        {% if form.errors %}
        <div class="alert alert-danger mt-4">
          <strong>Erros no formulário:</strong>
          <ul class="mb-0">
            {% for field in form %}
              {% for error in field.errors %}
                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<!-- Script para campos dinâmicos: Carga, T e MOD -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const seqInput = document.getElementById("seqInput");
  const cargasContainer = document.getElementById("cargasContainer");

  seqInput.addEventListener("input", () => {
    const qtd = parseInt(seqInput.value) || 0;
    cargasContainer.innerHTML = "";

    for (let i = 1; i <= qtd; i++) {
      const col = document.createElement("div");
      col.classList.add("col-12", "mb-3");
      col.innerHTML = `
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label">
              <i class="bi bi-box-seam text-secondary me-1"></i> Carga ${i} (Seq ${i})
            </label>
            <input type="text" name="carga_${i}" class="form-control text-muted" placeholder="Digite a carga ${i}" required />
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label">
              <i class="bi bi-clock-fill text-secondary me-1"></i> T ${i}
            </label>
            <input type="text" name="t_${i}" class="form-control text-muted" placeholder="Ex: Manhã" required />
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label">
              <i class="bi bi-gear-fill text-secondary me-1"></i> MOD ${i}
            </label>
            <input type="text" name="mod_${i}" class="form-control text-muted" placeholder="Ex: MOD123" required />
          </div>
        </div>
      `;
      cargasContainer.appendChild(col);
    }
  });
});
</script>
{% endblock %}
